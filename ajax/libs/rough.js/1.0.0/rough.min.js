var RoughCanvas=function(){'use strict';function a(a,b){0<arguments.length&&this.init(a,b)}var b=Math.tan,c=Math.sin,d=Math.cos,e=Math.PI,f=Math.sqrt,g=Math.max,h=Math.min,i=Math.abs,j=Number.MAX_VALUE;const k={LEFT:0,RIGHT:1,INTERSECTS:2,AHEAD:3,BEHIND:4,SEPARATE:5,UNDEFINED:6};class l{constructor(a,b,c,d){this.px1=a,this.py1=b,this.px2=c,this.py2=d,this.xi=j,this.yi=j,this.a=d-b,this.b=a-c,this.c=c*b-a*d,this._undefined=0==this.a&&0==this.b&&0==this.c}isUndefined(){return this._undefined}compare(d){if(this.isUndefined()||d.isUndefined())return k.UNDEFINED;var e=j,f=j,l=0,m=0,n=this.a,o=this.b,b=this.c;return(1e-5<i(o)&&(e=-n/o,l=-b/o),1e-5<i(d.b)&&(f=-d.a/d.b,m=-d.c/d.b),e==j)?f==j?-b/n==-d.c/d.a?this.py1>=h(d.py1,d.py2)&&this.py1<=g(d.py1,d.py2)?(this.xi=this.px1,this.yi=this.py1,k.INTERSECTS):this.py2>=h(d.py1,d.py2)&&this.py2<=g(d.py1,d.py2)?(this.xi=this.px2,this.yi=this.py2,k.INTERSECTS):k.SEPARATE:k.SEPARATE:(this.xi=this.px1,this.yi=f*this.xi+m,-1e-5>(this.py1-this.yi)*(this.yi-this.py2)||-1e-5>(d.py1-this.yi)*(this.yi-d.py2)?k.SEPARATE:1e-5>i(d.a)?-1e-5>(d.px1-this.xi)*(this.xi-d.px2)?k.SEPARATE:k.INTERSECTS:k.INTERSECTS):f==j?(this.xi=d.px1,this.yi=e*this.xi+l,-1e-5>(d.py1-this.yi)*(this.yi-d.py2)||-1e-5>(this.py1-this.yi)*(this.yi-this.py2)?k.SEPARATE:1e-5>i(n)?-1e-5>(this.px1-this.xi)*(this.xi-this.px2)?k.SEPARATE:k.INTERSECTS:k.INTERSECTS):e==f?l==m?this.px1>=h(d.px1,d.px2)&&this.px1<=g(d.py1,d.py2)?(this.xi=this.px1,this.yi=this.py1,k.INTERSECTS):this.px2>=h(d.px1,d.px2)&&this.px2<=g(d.px1,d.px2)?(this.xi=this.px2,this.yi=this.py2,k.INTERSECTS):k.SEPARATE:k.SEPARATE:(this.xi=(m-l)/(e-f),this.yi=e*this.xi+l,-1e-5>(this.px1-this.xi)*(this.xi-this.px2)||-1e-5>(d.px1-this.xi)*(this.xi-d.px2)?k.SEPARATE:k.INTERSECTS)}getLength(){return this._getLength(this.px1,this.py1,this.px2,this.py2)}_getLength(a,b,c,d){var e=c-a,g=d-b;return f(e*e+g*g)}}class m{constructor(a,b,c,d,e,f,g,h){this.top=a,this.bottom=b,this.left=c,this.right=d,this.gap=e,this.sinAngle=f,this.tanAngle=h,1e-4>i(f)?this.pos=c+e:.9999<i(f)?this.pos=a+e:(this.deltaX=(b-a)*i(h),this.pos=c-i(this.deltaX),this.hGap=i(e/g),this.sLeft=new l(c,b,c,a),this.sRight=new l(d,b,d,a))}getNextLine(){if(1e-4>i(this.sinAngle)){if(this.pos<this.right){let a=[this.pos,this.top,this.pos,this.bottom];return this.pos+=this.gap,a}}else if(!(.9999<i(this.sinAngle))){let a=this.pos-this.deltaX/2,b=this.pos+this.deltaX/2,c=this.bottom,d=this.top;if(this.pos<this.right+this.deltaX){for(;a<this.left&&b<this.left||a>this.right&&b>this.right;)if(this.pos+=this.hGap,a=this.pos-this.deltaX/2,b=this.pos+this.deltaX/2,this.pos>this.right+this.deltaX)return null;let e=new l(a,c,b,d);e.compare(this.sLeft)==k.INTERSECTS&&(a=e.xi,c=e.yi),e.compare(this.sRight)==k.INTERSECTS&&(b=e.xi,d=e.yi),0<this.tanAngle&&(a=this.right-(a-this.left),b=this.right-(b-this.left));let f=[a,c,b,d];return this.pos+=this.hGap,f}}else if(this.pos<this.bottom){let a=[this.left,this.pos,this.right,this.pos];return this.pos+=this.gap,a}return null}}class n{constructor(a){if(this._fields={},this._dirty=!1,this._canvas=null,this.z=0,this._roughness=null,this._bowing=null,this._stroke=null,this._strokeWidth=null,this._fill=null,this._fillStyle=null,this._fillWeight=null,this._hachureAngle=null,this._hachureGap=null,this._maxRandomnessOffset=null,this._curveTightness=0,a)for(var b=0;b<a.length;b++)this._defineRenderProperty(a[b])}_defineRenderProperty(a){Object.defineProperty(this,a,{get:function(){return this._get(a)},set:function(b){this._set(a,b)}})}get dirty(){return this._dirty}set roughness(a){this._roughness=a,this._canvas&&this._canvas.requestDraw()}get roughness(){return'number'==typeof this._roughness&&0<=this._roughness?this._roughness:this._canvas?this._canvas.roughness:this._roughness}set bowing(a){this._bowing=a,this._canvas&&this._canvas.requestDraw()}get bowing(){return'number'==typeof this._bowing&&0<=this._bowing?this._bowing:this._canvas?this._canvas.bowing:this._bowing}set stroke(a){this._stroke=a,this._canvas&&this._canvas.requestDraw()}get stroke(){return'string'==typeof this._stroke&&this._stroke?this._stroke:this._canvas?this._canvas.stroke:this._stroke}set strokeWidth(a){this._strokeWidth=a,this._canvas&&this._canvas.requestDraw()}get strokeWidth(){return'number'==typeof this._strokeWidth&&0<=this._strokeWidth?this._strokeWidth:this._canvas?this._canvas.strokeWidth:this._strokeWidth}set maxRandomnessOffset(a){this._maxRandomnessOffset=a,this._canvas&&this._canvas.requestDraw()}get maxRandomnessOffset(){return'number'==typeof this._maxRandomnessOffset&&0<=this._maxRandomnessOffset?this._maxRandomnessOffset:this._canvas?this._canvas.maxRandomnessOffset:this._maxRandomnessOffset}set curveTightness(a){this._curveTightness=g(h(a,1),0),this._canvas&&this._canvas.requestDraw()}get curveTightness(){return'number'==typeof this._curveTightness&&0<=this._curveTightness?this._curveTightness:this._canvas?this._canvas.curveTightness||0:this._curveTightness}set fill(a){this._fill=a,this._canvas&&this._canvas.requestDraw()}get fill(){return'string'==typeof this._fill&&this._fill?this._fill:this._canvas?this._canvas.fill:this._fill}set fillStyle(a){this._fillStyle=a,this._canvas&&this._canvas.requestDraw()}get fillStyle(){return'string'==typeof this._fillStyle&&this._fillStyle?this._fillStyle:this._canvas?this._canvas.fillStyle:this._fillStyle}set fillWeight(a){this._fillWeight=a,this._canvas&&this._canvas.requestDraw()}get fillWeight(){return'number'==typeof this._fillWeight&&this._fillWeight?this._fillWeight:this._canvas?this._canvas.fillWeight:this._fillWeight}set hachureAngle(a){this._hachureAngle=a,this._canvas&&this._canvas.requestDraw()}get hachureAngle(){return'number'==typeof this._hachureAngle&&0<=this._hachureAngle?this._hachureAngle:this._canvas?this._canvas.hachureAngle:this._hachureAngle}set hachureGap(a){this._hachureGap=a,this._canvas&&this._canvas.requestDraw()}get hachureGap(){return'number'==typeof this._hachureGap&&0<=this._hachureGap?this._hachureGap:this._canvas?this._canvas.hachureGap:this._hachureGap}attach(a,b){this.attached=!0,this._canvas=a,this.z=b}detach(){this.attached=!1,this.z=0}remove(){this.attached&&this._canvas&&this._canvas.remove(this)}_get(a){return this._fields[a]?this._fields[a]:null}_set(a,b,c=!0){this._fields[a]=b,c&&(this._dirty=!0,this._canvas&&this._canvas.requestDraw())}draw(a){console.log('Draw not implemented.',a)}getOffset(a,b){return this.roughness*(Math.random()*(b-a)+a)}drawLine(a,b,c,d,e,g){var h=Math.pow;let i=h(b-d,2)+h(b-d,2),j=this.maxRandomnessOffset||0;100*(j*j)>i&&(j=f(i)/10);let k=j/2,l=.2+.2*Math.random(),m=this.bowing*this.maxRandomnessOffset*(e-c)/200,n=this.bowing*this.maxRandomnessOffset*(b-d)/200;m=this.getOffset(-m,m),n=this.getOffset(-n,n),g||a.beginPath(),a.moveTo(b+this.getOffset(-j,j),c+this.getOffset(-j,j)),a.bezierCurveTo(m+b+(d-b)*l+this.getOffset(-j,j),n+c+(e-c)*l+this.getOffset(-j,j),m+b+2*(d-b)*l+this.getOffset(-j,j),n+c+2*(e-c)*l+this.getOffset(-j,j),d+this.getOffset(-j,j),e+this.getOffset(-j,j)),g||a.stroke(),g||a.beginPath(),a.moveTo(b+this.getOffset(-k,k),c+this.getOffset(-k,k)),a.bezierCurveTo(m+b+(d-b)*l+this.getOffset(-k,k),n+c+(e-c)*l+this.getOffset(-k,k),m+b+2*(d-b)*l+this.getOffset(-k,k),n+c+2*(e-c)*l+this.getOffset(-k,k),d+this.getOffset(-k,k),e+this.getOffset(-k,k)),g||a.stroke()}drawLinearPath(a,b,c){const d=b.length;if(2<d){a.beginPath();for(var e=0;e<d-1;e++)this.drawLine(a,b[e][0],b[e][1],b[e+1][0],b[e+1][1],!0);c&&this.drawLine(a,b[d-1][0],b[d-1][1],b[0][0],b[0][1],!0),a.stroke()}else 2==d&&this.drawLine(a,b[0][0],b[0][1],b[1][0],b[1][1])}drawCurve(a,c,d,e,f){const g=c.length;var h;if(3<g){var i=[];const b=1-this.curveTightness;for(d||a.beginPath(),a.moveTo(c[1][0],c[1][1]),h=1;h+2<g;h++){let d=c[h];i[0]=[d[0],d[1]],i[1]=[d[0]+(b*c[h+1][0]-b*c[h-1][0])/6,d[1]+(b*c[h+1][1]-b*c[h-1][1])/6],i[2]=[c[h+1][0]+(b*c[h][0]-b*c[h+2][0])/6,c[h+1][1]+(b*c[h][1]-b*c[h+2][1])/6],i[3]=[c[h+1][0],c[h+1][1]],a.bezierCurveTo(i[1][0],i[1][1],i[2][0],i[2][1],i[3][0],i[3][1])}if(e&&f&&2==f.length){let b=this.maxRandomnessOffset||0;a.lineTo(f[0]+this.getOffset(-b,b),f[1]+this.getOffset(-b,b))}d||a.stroke()}else 3==g?this.drawBezier(a,c[0][0],c[0][1],c[1][0],c[1][1],c[2][0],c[2][1],c[2][0],c[2][1],d):2==g&&this.drawLine(a,c[0][0],c[0][1],c[1][0],c[1][1],d)}drawBezier(a,b,c,d,e,f,g,h,i,j){j||a.beginPath(),a.moveTo(b,c);let k=this.maxRandomnessOffset||0;a.moveTo(b+this.getOffset(-k,k),c+this.getOffset(-k,k)),this._drawBezierTo(a,d,e,f,g,h,i),j||a.stroke()}_drawBezierTo(a,b,c,d,e,f,g){let h=this.maxRandomnessOffset||0,i=[f+this.getOffset(-h,h),g+this.getOffset(-h,h)];return a.bezierCurveTo(b+this.getOffset(-h,h),c+this.getOffset(-h,h),d+this.getOffset(-h,h),e+this.getOffset(-h,h),i[0],i[1]),i}_drawQuadTo(a,b,c,d,e){let f=this.maxRandomnessOffset||0,g=[d+this.getOffset(-f,f),e+this.getOffset(-f,f)];return a.quadraticCurveTo(b+this.getOffset(-f,f),c+this.getOffset(-f,f),g[0],g[1]),g}getIntersectingLines(a,b,c){let d=[];for(var e=new l(a[0],a[1],a[2],a[3]),f=0;f<b.length;f++){let a=new l(b[f],c[f],b[(f+1)%b.length],c[(f+1)%b.length]);e.compare(a)==k.INTERSECTS&&d.push([e.xi,e.yi])}return d}hachureFillShape(a,f,j){if(f&&j&&f.length&&j.length){var k=f[0],l=f[0],n=j[0],o=j[0];for(let a=1;a<f.length;a++)k=h(k,f[a]),l=g(l,f[a]),n=h(n,j[a]),o=g(o,j[a]);var i=this.hachureAngle,p=this.hachureGap;0>p&&(p=4*this.strokeWidth),p=g(p,.1);var q=this.fillWeight;0>q&&(q=this.strokeWidth/2);var r=i%180*(e/180),s=d(r),t=c(r),u=b(r);a.save(),a.strokeStyle=this.fill,a.lineWidth=q;for(var v,w=new m(n-1,o+1,k-1,l+1,p,t,s,u);null!=(v=w.getNextLine());){var x=this.getIntersectingLines(v,f,j);for(let b=0;b<x.length;b++)if(b<x.length-1){let c=x[b],d=x[b+1];this.drawLine(a,c[0],c[1],d[0],d[1])}}a.restore()}}}class o extends n{constructor(a,b,c,d,e,f,g){super(['x','y','width','height','start','stop','numSteps','closed']),this.x=a,this.y=b,this.width=c,this.height=d||c,this.start=e,this.stop=f,this.numSteps=9,this.closed=!!g}draw(a){let b=this.x,f=this.y,g=i(this.width/2),j=i(this.height/2);g+=this.getOffset(.01*-g,.01*g),j+=this.getOffset(.01*-j,.01*j);let k=this.start,l=this.stop;for(;0>k;)k+=2*e,l+=2*e;l-k>2*e&&(k=0,l=2*e);let m=2*e/this.numSteps,n=h(m/2,(l-k)/2);for(var o=[[b+g*d(k),f+j*c(k)]],p=k;p<=l;p+=n)o.push([b+g*d(p),f+j*c(p)]);if(o.push([b+g*d(l),f+j*c(l)]),o.push([b+g*d(l),f+j*c(l)]),this.fill&&this.closed&&this._doFill(a,o,[b,f]),a.save(),a.strokeStyle=this.stroke,a.lineWidth=this.strokeWidth,this.drawCurve(a,o),this.closed){const c=o.length-1;this.drawLine(a,o[0][0],o[0][1],b,f),this.drawLine(a,o[c][0],o[c][1],b,f)}a.restore()}_doFill(a,b,f){var g=this.fillStyle||'hachure';switch(g){case'solid':{a.save(),a.fillStyle=this.fill,a.beginPath(),this.drawCurve(a,b,!0,!0,f),a.fill(),a.restore();break}default:{let b=this.x,f=this.y,g=this.start,k=this.stop,l=i(this.width/2),m=i(this.height/2);for(;0>g;)g+=2*e,k+=2*e;k-g>2*e&&(g=0,k=2*e);let n=(k-g)/this.numSteps;for(var h=[[b,f],[b+l*d(g),f+m*c(g)]],j=g;j<=k;j+=n)h.push([b+l*d(j),f+m*c(j)]);h.push([b+l*d(k),f+m*c(k)]);let o=[],q=[];h.forEach(function(a){o.push(a[0]),q.push(a[1])}),this.hachureFillShape(a,o,q);break}}}}class p extends n{constructor(a,b,c,d){super(['x','y','width','height','numSteps']),this.x=a,this.y=b,this.width=c,this.height=d||c,this.numSteps=9}draw(a){this.ellipseInc=2*e/this.numSteps;let b=i(this.width/2),c=i(this.height/2);b+=this.getOffset(.05*-b,.05*b),c+=this.getOffset(.05*-c,.05*c),this.fill&&this._doFill(a,b,c),a.save(),a.strokeStyle=this.stroke,a.lineWidth=this.strokeWidth,this._ellipse(a,this.x,this.y,b,c,1,this.ellipseInc*this.getOffset(.1,this.getOffset(.4,1))),this._ellipse(a,this.x,this.y,b,c,1.5,0),a.restore()}_ellipse(a,b,f,g,h,i,j,k){var l=this.getOffset(-.5,.5)-e/2,m=[];m.push([this.getOffset(-i,i)+b+.9*g*d(l-this.ellipseInc),this.getOffset(-i,i)+f+.9*h*c(l-this.ellipseInc)]);for(var n=l;n<2*e+l-.01;n+=this.ellipseInc)m.push([this.getOffset(-i,i)+b+g*d(n),this.getOffset(-i,i)+f+h*c(n)]);m.push([this.getOffset(-i,i)+b+g*d(l+2*e+.5*j),this.getOffset(-i,i)+f+h*c(l+2*e+.5*j)]),m.push([this.getOffset(-i,i)+b+.98*g*d(l+j),this.getOffset(-i,i)+f+.98*h*c(l+j)]),m.push([this.getOffset(-i,i)+b+.9*g*d(l+.5*j),this.getOffset(-i,i)+f+.9*h*c(l+.5*j)]),this.drawCurve(a,m,k)}_doFill(a,c,d){var g=this.fillStyle||'hachure';switch(g){case'solid':{a.save(),a.fillStyle=this.fill,a.strokeStyle=null,a.beginPath(),this._ellipse(a,this.x,this.y,c,d,1,this.ellipseInc*this.getOffset(.1,this.getOffset(.4,1)),!0),a.fill(),a.restore();break}default:{var h=this.hachureAngle,i=this.hachureGap;0>=i&&(i=4*this.strokeWidth);var j=this.fillWeight;0>j&&(j=this.strokeWidth/2);var k=h%180*(e/180),l=b(k),m=this.x,n=this.y,o=d/c,p=f(o*l*o*l+1),q=o*l/p,r=1/p,s=i/(c*d/f(d*r*(d*r)+c*q*(c*q))/c),t=f(c*c-(m-c+s)*(m-c+s));a.save(),a.strokeStyle=this.fill,a.lineWidth=j;for(var u=m-c+s;u<m+c;u+=s){t=f(c*c-(m-u)*(m-u));let b=this.affine(u,n-t,m,n,q,r,o),d=this.affine(u,n+t,m,n,q,r,o);this.drawLine(a,b[0],b[1],d[0],d[1])}a.restore();break}}}affine(a,b,c,d,e,f,g){return[-c*f-d*e+c+f*a+e*b,g*(c*e-d*f)+d+-g*e*a+g*f*b]}}class q extends p{constructor(a,b,c){super(a,b,2*c)}get radius(){return this.width/2}set radius(a){this.width=2*a,this.height=2*a}}class r extends n{constructor(a){super(),this._points=a}setPoint(a,b,c){this._points[a]=[b,c],this._canvas&&this._canvas.requestDraw()}getPoint(a){return 0<a&&a<this._points.length?this._points[a]:null}draw(a){a.save(),a.strokeStyle=this.stroke,a.lineWidth=this.strokeWidth;let b=this.maxRandomnessOffset||0;var c=[],d=[];c.push(this._points[0]),c.push(this._points[0]);var e=[this._points[0][0]+this.getOffset(-b,b),this._points[0][1]+this.getOffset(-b,b)];d.push(e),d.push(e);for(var f=this._points.length-1,g=1;g<f;g++)c.push(this._points[g]),0==g%3?d.push([this._points[g][0]+this.getOffset(-b,b),this._points[g][1]+this.getOffset(-b,b)]):d.push(this._points[g]);c.push(this._points[f]),c.push(this._points[f]);var h=[this._points[f][0]+this.getOffset(-b,b),this._points[f][1]+this.getOffset(-b,b)];d.push(h),d.push(h),this.drawCurve(a,c),this.drawCurve(a,d),a.restore()}}class s extends n{constructor(a,b,c,d){super(['x1','y1','x2','y2']),this.x1=a,this.x2=c,this.y1=b,this.y2=d}draw(a){a.save(),a.strokeStyle=this.stroke,a.lineWidth=this.strokeWidth,this.drawLine(a,this.x1,this.y1,this.x2,this.y2),a.restore()}}class t extends n{constructor(a){super(),this._points=a}setPoint(a,b,c){this._points[a]=[b,c],this._canvas&&this._canvas.requestDraw()}getPoint(a){return 0<a&&a<this._points.length?this._points[a]:null}draw(a){a.save(),a.strokeStyle=this.stroke,a.lineWidth=this.strokeWidth,this.drawLinearPath(a,this._points,!1),a.restore()}}a.prototype.init=function(a,b){this.type=a,this.text=b},a.prototype.typeis=function(a){return this.type==a};class u{constructor(a){this.PARAMS={A:['rx','ry','x-axis-rotation','large-arc-flag','sweep-flag','x','y'],a:['rx','ry','x-axis-rotation','large-arc-flag','sweep-flag','x','y'],C:['x1','y1','x2','y2','x','y'],c:['x1','y1','x2','y2','x','y'],H:['x'],h:['x'],L:['x','y'],l:['x','y'],M:['x','y'],m:['x','y'],Q:['x1','y1','x','y'],q:['x1','y1','x','y'],S:['x2','y2','x','y'],s:['x2','y2','x','y'],T:['x','y'],t:['x','y'],V:['y'],v:['y'],Z:[],z:[]},this.COMMAND=0,this.NUMBER=1,this.EOD=2,this.segments=[],this.d=a||'',this.parseData(a)}parseData(a){var b=this.tokenize(a),c=0,d=b[c],e='BOD';for(this.segments=[];!d.typeis(this.EOD);){var f,g=[];if(!('BOD'==e))d.typeis(this.NUMBER)?f=this.PARAMS[e].length:(c++,f=this.PARAMS[d.text].length,e=d.text);else if('M'==d.text||'m'==d.text)c++,f=this.PARAMS[d.text].length,e=d.text;else return void console.error('Path data must begin with a MoveTo command');if(c+f<b.length){for(var h,j=c;j<c+f;j++)if(h=b[j],h.typeis(this.NUMBER))g[g.length]=h.text;else return void console.error('Parameter type is not a number: '+e+','+h.text);var i;if(this.PARAMS[e])i={key:e,data:g};else return void console.error('Unsupported segment type: '+e);this.segments.push(i),c+=f,d=b[c],'M'==e&&(e='L'),'m'==e&&(e='l')}else console.error('Path data ended before all parameters were found')}}tokenize(b){for(var c=[];''!=b;)if(b.match(/^([ \t\r\n,]+)/))b=b.substr(RegExp.$1.length);else if(b.match(/^([aAcChHlLmMqQsStTvVzZ])/))c[c.length]=new a(this.COMMAND,RegExp.$1),b=b.substr(RegExp.$1.length);else if(b.match(/^(([-+]?[0-9]+(\.[0-9]*)?|[-+]?\.[0-9]+)([eE][-+]?[0-9]+)?)/))c[c.length]=new a(this.NUMBER,parseFloat(RegExp.$1)),b=b.substr(RegExp.$1.length);else return console.error('Unrecognized segment command: '+b),null;return c[c.length]=new a(this.EOD,null),c}}class v{constructor(a,b,g,h,j,k){const l=e/180;if(this._segIndex=0,this._numSegs=0,a[0]==b[0]&&a[1]==b[1])return;this._rx=i(g[0]),this._ry=i(g[1]),this._sinPhi=c(h*l),this._cosPhi=d(h*l);var m,n=this._cosPhi*(a[0]-b[0])/2+this._sinPhi*(a[1]-b[1])/2,o=-this._sinPhi*(a[0]-b[0])/2+this._cosPhi*(a[1]-b[1])/2,p=this._rx*this._rx*this._ry*this._ry-this._rx*this._rx*o*o-this._ry*this._ry*n*n;if(0>p){let a=f(1-p/(this._rx*this._rx*this._ry*this._ry));this._rx=a,this._ry=a,m=0}else m=(j==k?-1:1)*f(p/(this._rx*this._rx*o*o+this._ry*this._ry*n*n));let q=m*this._rx*o/this._ry,r=-m*this._ry*n/this._rx;this._C=[0,0],this._C[0]=this._cosPhi*q-this._sinPhi*r+(a[0]+b[0])/2,this._C[1]=this._sinPhi*q+this._cosPhi*r+(a[1]+b[1])/2,this._theta=this.calculateVectorAngle(1,0,(n-q)/this._rx,(o-r)/this._ry);let s=this.calculateVectorAngle((n-q)/this._rx,(o-r)/this._ry,(-n-q)/this._rx,(-o-r)/this._ry);!k&&0<s?s-=2*e:k&&0>s&&(s+=2*e),this._numSegs=Math.ceil(i(s/(e/2))),this._delta=s/this._numSegs,this._T=8/3*c(this._delta/4)*c(this._delta/4)/c(this._delta/2),this._from=a}getNextSegment(){var a,b,e;if(this._segIndex==this._numSegs)return null;let f=d(this._theta),g=c(this._theta),h=this._theta+this._delta,i=d(h),j=c(h);return e=[this._cosPhi*this._rx*i-this._sinPhi*this._ry*j+this._C[0],this._sinPhi*this._rx*i+this._cosPhi*this._ry*j+this._C[1]],a=[this._from[0]+this._T*(-this._cosPhi*this._rx*g-this._sinPhi*this._ry*f),this._from[1]+this._T*(-this._sinPhi*this._rx*g+this._cosPhi*this._ry*f)],b=[e[0]+this._T*(this._cosPhi*this._rx*j+this._sinPhi*this._ry*i),e[1]+this._T*(this._sinPhi*this._rx*j-this._cosPhi*this._ry*i)],this._theta=h,this._from=[e[0],e[1]],this._segIndex++,{cp1:a,cp2:b,to:e}}calculateVectorAngle(a,b,c,d){var f=Math.atan2;let g=f(b,a),h=f(d,c);return h>=g?h-g:2*e-(g-h)}}class w extends n{constructor(a){super(['path','numSteps']),this.numSteps=9,this.path=a,this._keys=['C','c','Q','q','M','m','L','l','A','a','H','h','V','v','S','s','T','t','Z','z']}draw(a){if(this.path){var b=(this.path||'').replace(/\n/g,' ').replace(/(-)/g,' -').replace(/(-\s)/g,'-').replace('/(ss)/g',' ');this.gp=new u(b);var c=this.gp.segments||[];this._position=[0,0],this._bezierReflectionPoint=null,this._quadReflectionPoint=null,this._first=null,this.fill&&this._doFill(a,b),a.save(),a.strokeStyle=this.stroke,a.lineWidth=this.strokeWidth,a.beginPath();for(var d,e=0;e<c.length;e++)d=c[e],this._processSegment(a,d,0<e?c[e-1]:null);a.stroke(),a.restore()}}_doFill(a,b){var c=this.fillStyle||'hachure';switch(c){case'solid':{a.save(),a.fillStyle=this.fill;let c=new Path2D(b);a.fill(c),a.restore();break}default:{var d=this._canvas.getHiddenCanvas();if(d){const a=d.getContext('2d');let b=[0,d.width,d.width,0],c=[0,0,d.height,d.height];this.hachureFillShape(a,b,c)}a.save(),a.fillStyle=a.createPattern(d,'repeat');let c=new Path2D(b);a.fill(c),a.restore();break}}}_processSegment(a,b,c){switch(b.key){case'M':case'm':this._moveTo(b);break;case'L':case'l':this._lineTo(a,b);break;case'H':case'h':this._hLineTo(a,b);break;case'V':case'v':this._vLineTo(a,b);break;case'Z':case'z':this._closeShape(a);break;case'C':case'c':this._curveTo(a,b);break;case'S':case's':this._shortCurveTo(a,b,c);break;case'Q':case'q':this._quadCurveTo(a,b);break;case'T':case't':this._shortQuadTo(a,b,c);break;case'A':case'a':this._arcTo(a,b);break;default:}}_setPosition(a,b){this._position=[a,b],this._first||(this._first=[a,b])}_moveTo(a){var b='m'===a.key;if(2<=a.data.length){let c=+a.data[0],d=+a.data[1];b?this._setPosition(this._position[0]+c,this._position[1]+d):this._setPosition(c,d)}}_closeShape(a){this._first&&this.drawLine(a,this._position[0],this._position[1],this._first[0],this._first[1],!0)}_lineTo(a,b){var c='l'===b.key;if(2<=b.data.length){let d=+b.data[0],e=+b.data[1];c&&(d+=this._position[0],e+=this._position[1]),this.drawLine(a,this._position[0],this._position[1],d,e,!0),this._setPosition(d,e)}}_hLineTo(a,b){var c='h'===b.key;if(b.data.length){let d=+b.data[0];c&&(d+=this._position[0]),this.drawLine(a,this._position[0],this._position[1],d,this._position[1],!0),this._setPosition(d,this._position[1])}}_vLineTo(a,b){var c='v'===b.key;if(b.data.length){let d=+b.data[0];c&&(d+=this._position[1]),this.drawLine(a,this._position[0],this._position[1],this._position[0],d,!0),this._setPosition(this._position[0],d)}}_quadCurveTo(a,b){var c='q'===b.key;if(4<=b.data.length){let d=+b.data[0],e=+b.data[1],f=+b.data[2],g=+b.data[3];c&&(d+=this._position[0],f+=this._position[0],e+=this._position[1],g+=this._position[1]);let h=this.maxRandomnessOffset||0;a.moveTo(this._position[0],this._position[1]),this._drawQuadTo(a,d,e,f,g),a.moveTo(this._position[0]+this.getOffset(-h,h),this._position[1]+this.getOffset(-h,h));let i=this._drawQuadTo(a,d,e,f,g);f=i[0],g=i[1],this._setPosition(f,g),this._quadReflectionPoint=[f+(f-d),g+(g-e)]}}_curveTo(a,b){var c='c'===b.key;if(6<=b.data.length){let d=+b.data[0],e=+b.data[1],f=+b.data[2],g=+b.data[3],h=+b.data[4],i=+b.data[5];c&&(d+=this._position[0],f+=this._position[0],h+=this._position[0],e+=this._position[1],g+=this._position[1],i+=this._position[1]);let j=this.maxRandomnessOffset||0;a.moveTo(this._position[0],this._position[1]),this._drawBezierTo(a,d,e,f,g,h,i),a.moveTo(this._position[0]+this.getOffset(-j,j),this._position[1]+this.getOffset(-j,j));let k=this._drawBezierTo(a,d,e,f,g,h,i);h=k[0],i=k[1],this._setPosition(h,i),this._bezierReflectionPoint=[h+(h-f),i+(i-g)]}}_shortCurveTo(a,b,c){var d='s'===b.key;if(4<=b.data.length){let g=+b.data[0],h=+b.data[1],i=+b.data[2],j=+b.data[3];d&&(g+=this._position[0],i+=this._position[0],h+=this._position[1],j+=this._position[1]);let k=g,l=h,m=c?c.key:'';var e=null;('c'==m||'C'==m||'s'==m||'S'==m)&&(e=this._bezierReflectionPoint),e&&(k=e[0],l=e[1]),a.moveTo(this._position[0],this._position[1]),this._drawBezierTo(a,k,l,g,h,i,j),a.moveTo(this._position[0],this._position[1]);var f=this._drawBezierTo(a,k,l,g,h,i,j);i=f[0],j=f[1],this._setPosition(i,j),this._bezierReflectionPoint=[i+(i-g),j+(j-h)]}}_shortQuadTo(a,b,c){var d='t'===b.key;if(2<=b.data.length){let f=+b.data[0],g=+b.data[1];d&&(f+=this._position[0],g+=this._position[1]);let h=f,i=g,j=c?c.key:'';var e=null;('q'==j||'Q'==j||'t'==j||'T'==j)&&(e=this._quadReflectionPoint),e&&(h=e[0],i=e[1]),a.moveTo(this._position[0],this._position[1]),this._drawQuadTo(a,h,i,f,g),a.moveTo(this._position[0],this._position[1]);let k=this._drawQuadTo(a,h,i,f,g);f=k[0],g=k[1],this._setPosition(f,g),this._quadReflectionPoint=[f+(f-h),g+(g-i)]}}_arcTo(a,b){var c='a'===b.key;if(7<=b.data.length){let h=+b.data[0],i=+b.data[1],j=+b.data[2],k=+b.data[3],l=+b.data[4],m=+b.data[5],n=+b.data[6];if(c&&(m+=this._position[0],n+=this._position[1]),m==this._position[0]&&n==this._position[1])return;if(0==h||0==i)this.drawLine(a,this._position[0],this._position[1],m,n,!0),this._setPosition(m,n);else{for(var d,e=0;2>e;e++){a.moveTo(this._position[0],this._position[1]);for(var f=new v([this._position[0],this._position[1]],[m,n],[h,i],j,!!k,!!l),g=f.getNextSegment();g;)d=this._drawBezierTo(a,g.cp1[0],g.cp1[1],g.cp2[0],g.cp2[1],g.to[0],g.to[1]),g=f.getNextSegment()}d&&(m=d[0],n=d[1]),this._setPosition(m,n)}}}}class x extends n{constructor(a){super(),this._points=a}setPoint(a,b,c){this._points[a]=[b,c],this._canvas&&this._canvas.requestDraw()}getPoint(a){return 0<a&&a<this._points.length?this._points[a]:null}draw(a){this.fill&&this._doFill(a,this._points),a.save(),a.strokeStyle=this.stroke,a.lineWidth=this.strokeWidth,this.drawLinearPath(a,this._points,!0),a.restore()}_doFill(a,b){var c=this.fillStyle||'hachure';switch(c){case'solid':{a.save(),a.fillStyle=this.fill;let c=this.maxRandomnessOffset||0;const e=b.length;if(2<e){a.beginPath(),a.moveTo(b[0][0]+this.getOffset(-c,c),b[0][1]+this.getOffset(-c,c));for(var d=1;d<e;d++)a.lineTo(b[d][0]+this.getOffset(-c,c),b[d][1]+this.getOffset(-c,c));a.fill()}a.restore();break}default:{let c=[],d=[];b.forEach(function(a){c.push(a[0]),d.push(a[1])}),this.hachureFillShape(a,c,d);break}}}}class z extends n{constructor(a,b,c,d){super(['x','y','width','height']),this.x=a,this.y=b,this.width=c,this.height=d}draw(a){let b=this.x,c=this.x+this.width,d=this.y,e=this.y+this.height;this.fill&&this._doFill(a,b,c,d,e),a.save(),a.strokeStyle=this.stroke,a.lineWidth=this.strokeWidth,this.drawLine(a,b,d,c,d),this.drawLine(a,c,d,c,e),this.drawLine(a,c,e,b,e),this.drawLine(a,b,e,b,d),a.restore()}_doFill(a,b,c,d,e){var f=this.fillStyle||'hachure';switch(f){case'solid':{a.save(),a.fillStyle=this.fill;let f=this.maxRandomnessOffset||0;var g=[[b+this.getOffset(-f,f),d+this.getOffset(-f,f)],[c+this.getOffset(-f,f),d+this.getOffset(-f,f)],[c+this.getOffset(-f,f),e+this.getOffset(-f,f)],[b+this.getOffset(-f,f),e+this.getOffset(-f,f)]];a.beginPath(),a.moveTo(g[0][0],g[0][1]),a.lineTo(g[1][0],g[1][1]),a.lineTo(g[2][0],g[2][1]),a.lineTo(g[3][0],g[3][1]),a.fill(),a.restore();break}default:{this.hachureFillShape(a,[b,c,c,b],[d,d,e,e]);break}}}}return class{constructor(a,b,c){this._canvas=a,this.width=b||a.width,this.height=c||a.height,a.width=this.width,a.height=this.height,this._objects=[],this._drawRequested=!1,this.roughness=1,this.bowing=1,this.stroke='#000',this.strokeWidth=1,this.fill=null,this.fillStyle='hachure',this.fillWeight=-1,this.hachureAngle=-41,this.hachureGap=-1,this.maxRandomnessOffset=2}add(a){if(a instanceof n){if(a.attached)return;this._objects.push(a),a.attach(this,this._objects.length-1),this.requestDraw()}else console.warn('Ignoring canvas add - the object is not drawable',a)}remove(a){a instanceof n?a.attached&&(this._objects.splice(a.z,1),a.detach(),this.requestDraw()):console.warn('Ignoring canvas remove - the object is not drawable',a)}clear(){this._objects&&this._objects.length&&this._objects.forEach(function(a){a.detach()}),this._objects=[],this.requestDraw()}requestDraw(){this._drawRequested||(this._drawRequested=!0,window.requestAnimationFrame(()=>{this._drawRequested=!1,this._draw()}))}_draw(){const a=this._canvas.getContext('2d');a.clearRect(0,0,this.width,this.height);for(var b=0;b<this._objects.length;b++)try{this._objects[b].draw(a)}catch(a){console.error(a)}}getHiddenCanvas(){if(!this._hiddenCanvas){var a=document.createElement('div');a.setAttribute('id','roughHiddenCanvas'),a.style.overflow='hidden',a.style.position='absolute',a.style.left='-1px',a.style.top='-1px',a.style.width='0px',a.style.height='0px',a.style.opacity=0,a.style.pointerEvents='none',document.body.appendChild(a),this._hiddenCanvas=document.createElement('canvas'),a.appendChild(this._hiddenCanvas)}var b=this._hiddenCanvas;b.width=this.width,b.height=this.height;const c=b.getContext('2d');return c.clearRect(0,0,this.width,this.height),b}arc(a,b,c,e,f,g,h){var i=new o(a,b,c,e,f,g,h);return this.add(i),i}circle(a,b,c){var e=new q(a,b,c);return this.add(e),e}ellipse(a,b,c,e){var f=new p(a,b,c,e);return this.add(f),f}curve(a){var b=new r(a);return this.add(b),b}line(a,b,c,e){var f=new s(a,b,c,e);return this.add(f),f}rectangle(a,b,c,e){var f=new z(a,b,c,e);return this.add(f),f}linearPath(a){var b=new t(a);return this.add(b),b}polygon(a){var b=new x(a);return this.add(b),b}path(a){var b=new w(a);return this.add(b),b}}}();